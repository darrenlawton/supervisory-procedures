{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://supervisory-procedures/schema/skill.schema.json",
  "title": "Agent Skill",
  "description": "Supervisory Procedures — Agent Skill definition schema v2.0",
  "type": "object",
  "required": [
    "metadata",
    "context",
    "scope",
    "constraints",
    "control_points",
    "workflow"
  ],
  "additionalProperties": false,
  "properties": {

    "metadata": {
      "type": "object",
      "required": [
        "id",
        "name",
        "version",
        "schema_version",
        "business_area",
        "supervisor",
        "status",
        "created_at",
        "approved_at",
        "approved_by",
        "authorised_agents"
      ],
      "additionalProperties": false,
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z0-9_]+/[a-z0-9_-]+$",
          "description": "<business_area>/<kebab-name>, e.g. retail_banking/loan-application-processing"
        },
        "name": {
          "type": "string",
          "minLength": 1
        },
        "version": {
          "type": "string",
          "pattern": "^(0|[1-9]\\d*)\\.(0|[1-9]\\d*)\\.(0|[1-9]\\d*)$",
          "description": "Semantic version, e.g. 1.0.0"
        },
        "schema_version": {
          "type": "string",
          "enum": ["2.0"],
          "description": "Hub-controlled schema version"
        },
        "business_area": {
          "type": "string",
          "pattern": "^[a-z0-9_]+$",
          "description": "Slug matching registry directory name"
        },
        "type": {
          "type": "string",
          "enum": ["standard", "shared"],
          "description": "Skill type. 'shared' indicates a centrally-maintained helper skill in registry/shared/ available for reuse across business areas."
        },
        "supervisor": {
          "type": "object",
          "required": ["name", "email", "role"],
          "additionalProperties": false,
          "properties": {
            "name": { "type": "string", "minLength": 1 },
            "email": { "type": "string", "format": "email" },
            "role": { "type": "string", "minLength": 1 }
          }
        },
        "status": {
          "type": "string",
          "enum": ["draft", "approved", "deprecated"]
        },
        "created_at": {
          "type": "string",
          "format": "date",
          "description": "ISO 8601 date, e.g. 2024-01-15"
        },
        "approved_at": {
          "oneOf": [
            { "type": "string", "format": "date" },
            { "type": "null" }
          ]
        },
        "approved_by": {
          "oneOf": [
            { "type": "string", "minLength": 1 },
            { "type": "null" }
          ]
        },
        "authorised_agents": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "minItems": 1,
          "description": "Agent IDs allowed to load this skill. ['*'] is permitted but triggers a CI warning."
        }
      }
    },

    "context": {
      "type": "object",
      "required": [
        "description",
        "business_rationale",
        "applicable_regulations",
        "risk_classification"
      ],
      "additionalProperties": false,
      "properties": {
        "description": {
          "type": "string",
          "minLength": 1,
          "description": "What business activity this skill governs"
        },
        "business_rationale": {
          "type": "string",
          "minLength": 1,
          "description": "Why AI assistance is appropriate here"
        },
        "applicable_regulations": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "description": "Regulatory references, e.g. FCA CONC 5.2"
        },
        "risk_classification": {
          "type": "string",
          "enum": ["low", "medium", "high", "critical"]
        }
      }
    },

    "scope": {
      "type": "object",
      "required": ["approved_activities"],
      "additionalProperties": false,
      "properties": {
        "approved_activities": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "description"],
            "additionalProperties": false,
            "properties": {
              "id": {
                "type": "string",
                "pattern": "^[a-z0-9-]+$",
                "description": "Slug identifier for this activity, e.g. audit-log"
              },
              "description": {
                "type": "string",
                "minLength": 1,
                "description": "Plain English description of what the agent does"
              }
            }
          },
          "minItems": 1,
          "description": "Exhaustive list of what the agent MAY do. Each entry has an id and description. workflow.steps[].activity references an activity id."
        }
      }
    },

    "constraints": {
      "type": "object",
      "required": ["procedural_requirements", "unacceptable_actions"],
      "additionalProperties": false,
      "properties": {
        "procedural_requirements": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "minItems": 0,
          "description": "Cross-cutting behavioural principles the agent must observe throughout the workflow. Do not repeat constraints already expressed by workflow ordering, control points, or unacceptable_actions."
        },
        "unacceptable_actions": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "minItems": 1,
          "description": "Absolute prohibitions — must NEVER do"
        }
      }
    },

    "control_points": {
      "type": "array",
      "minItems": 1,
      "description": "Unified set of control points governing agent oversight. Each control point declares the level of human involvement required and when it activates.",
      "items": {
        "type": "object",
        "required": ["id", "name", "description", "classification"],
        "additionalProperties": false,
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^[a-z0-9_-]+$",
            "description": "Slug identifier, e.g. sanctions-match"
          },
          "name": {
            "type": "string",
            "minLength": 1
          },
          "description": {
            "type": "string",
            "minLength": 1,
            "description": "Plain English description of what this control point represents and what action is taken."
          },
          "classification": {
            "type": "string",
            "enum": ["auto", "notify", "review", "needs_approval", "vetoed"],
            "description": "auto: agent proceeds without human involvement. notify: a human is informed but not blocked. review: a human actively reviews and can flag issues before the agent continues. needs_approval: explicit human sign-off is required before the agent continues. vetoed: the agent halts immediately and unconditionally; no human override is possible."
          },
          "trigger_condition": {
            "type": "string",
            "minLength": 1,
            "description": "Plain English condition that activates this control point. If present, the control point fires automatically when the condition is met. If absent, it must be referenced from a workflow step via the control_point field."
          },
          "condition_hint": {
            "type": "string",
            "description": "Optional technical hint for agent developers, e.g. field expressions or pseudocode."
          },
          "who_reviews": {
            "type": "string",
            "minLength": 1,
            "description": "Role or team responsible for review. Expected for notify, review, and needs_approval classifications."
          },
          "escalation_contact": {
            "type": "string",
            "description": "Contact for escalation or notification. Most relevant for vetoed classification."
          },
          "sla_hours": {
            "type": "integer",
            "minimum": 1,
            "description": "Optional time limit in hours for the human action."
          }
        }
      }
    },

    "workflow": {
      "type": "object",
      "description": "The ordered sequence of steps the agent must follow to execute this skill.",
      "required": ["steps"],
      "additionalProperties": false,
      "properties": {
        "steps": {
          "type": "array",
          "minItems": 1,
          "description": "Each step maps 1:1 to an approved_activity. Steps are executed in order.",
          "items": {
            "type": "object",
            "required": ["id", "activity"],
            "additionalProperties": false,
            "properties": {
              "id": {
                "type": "string",
                "pattern": "^[a-z0-9-]+$",
                "description": "Unique slug identifier for this step within the workflow."
              },
              "activity": {
                "type": "string",
                "pattern": "^[a-z0-9-]+$",
                "description": "ID of an approved activity in scope.approved_activities."
              },
              "control_point": {
                "type": "string",
                "pattern": "^[a-z0-9_-]+$",
                "description": "ID of a control_point (without trigger_condition) that gates progression after this step completes."
              },
              "uses_skill": {
                "type": "string",
                "pattern": "^shared/[a-z0-9_-]+$",
                "description": "ID of a centrally-maintained helper skill in registry/shared/ that executes this step."
              }
            }
          }
        }
      }
    },

    "helper_skills": {
      "type": "array",
      "description": "Centrally-maintained helper skills from registry/shared/ that this skill delegates to in its workflow.",
      "items": {
        "type": "object",
        "required": ["id", "purpose"],
        "additionalProperties": false,
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^shared/[a-z0-9_-]+$",
            "description": "Skill ID in the shared registry, e.g. shared/audit-logging."
          },
          "purpose": {
            "type": "string",
            "minLength": 1,
            "description": "Why this helper skill is used in this workflow."
          },
          "required": {
            "type": "boolean",
            "description": "Whether this helper skill is required for the workflow to execute."
          }
        }
      }
    }

  }
}
